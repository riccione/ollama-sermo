<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ollama Chat</title>
    <link rel="stylesheet" href="simple.min.css">
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
        #prompt, #system_prompt { width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body class="dark">
    <label>Ollama Host:</label>
    <input type="text" id="ollama_url" value="http://localhost:11434"><br>

    <label>System Prompt:</label>
    <input type="text" id="system_prompt" placeholder="Optional system prompt"><br><br>

    <label>Model:</label>
    <select id="model_select"></select><br><br>

    <div id="chat"></div>

    <input type="text" id="prompt" placeholder="Type your message...">
    <button id="send_button" onclick="sendPrompt()">Send</button>

    <script>
        // global var to store all messages in a chat
        const messages = [];

        async function fetchModels() {
            const url = document.getElementById('ollama_url').value;
            const res = await fetch('/models?host=' + encodeURIComponent(url));
            const models = await res.json();
            const select = document.getElementById('model_select');
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                select.appendChild(opt);
            });
        }

        async function sendPrompt() {
          const host = document.getElementById('ollama_url').value;
          const model = document.getElementById('model_select').value;
          const promptInput = document.getElementById('prompt');
          const prompt = promptInput.value.trim();
          const system_prompt = document.getElementById('system_prompt').value;
          const sendButton = document.getElementById('send_button');
          const chatDiv = document.getElementById('chat');

          if (!prompt) return;

          // user msg
          chatDiv.innerHTML += `<div><b>You:</b> ${prompt}</div>`;
          messages.push({ role: 'user', content: prompt });

          const botMessage = document.createElement("div");
          botMessage.innerHTML = `<b>Bot:</b> <i>thinking...</i>`;
          chatDiv.appendChild(botMessage);

          sendButton.disabled = true;
          promptInput.disabled = true;

          try {
            // adding system msg only once
            if (!messages.some(m => m.role === 'system')) {
              messages.unshift({ role: 'system', content: system_prompt });
            }

            const res = await fetch('/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                host,
                model,
                messages
              })
            });

            if (!res.ok || !res.body) {
              throw new Error("Network or response error");
            }

            // replacing "thinking..." with streamed response
            botMessage.innerHTML = `<b>Bot:</b> `;

            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullResponse = '';

            while (true) {
              const { value, done } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              fullResponse += chunk;
              botMessage.innerHTML += chunk;

              // auto-scroll
              chatDiv.scrollTop = chatDiv.scrollHeight;
            }

            // response to the full message history
            messages.push({ role: 'assistant', content: fullResponse });

          } catch (err) {
            botMessage.innerHTML = `<b>Error:</b> ${err.message}`;
          } finally {
            sendButton.disabled = false;
            promptInput.disabled = false;
            promptInput.value = '';
            promptInput.focus();
          }
        }
    
        fetchModels();
    </script>
</body>
</html>
