<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ollama Chat</title>
    <link rel="stylesheet" href="simple.min.css">
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
        #prompt, #system_prompt { width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body class="dark">
    <label>Ollama Host:</label>
    <input type="text" id="ollama_url" value="http://localhost:11434"><br>

    <label>System Prompt:</label>
    <input type="text" id="system_prompt" placeholder="Optional system prompt"><br><br>

    <label>Model:</label>
    <select id="model_select"></select><br><br>

    <div id="chat"></div>

    <input type="text" id="prompt" placeholder="Type your message...">
    <button id="send_button" onclick="sendPrompt()">Send</button>

    <script>
        async function fetchModels() {
            const url = document.getElementById('ollama_url').value;
            const res = await fetch('/models?host=' + encodeURIComponent(url));
            const models = await res.json();
            const select = document.getElementById('model_select');
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                select.appendChild(opt);
            });
        }

    async function sendPrompt() {
        const host = document.getElementById('ollama_url').value;
        const model = document.getElementById('model_select').value;
        const promptInput = document.getElementById('prompt');
        const prompt = promptInput.value;
        const system_prompt = document.getElementById('system_prompt').value;
        const sendButton = document.getElementById('send_button');
        const chatDiv = document.getElementById('chat');

        // show user message
        chatDiv.innerHTML += `<div><b>You:</b> ${prompt}</div>`;

        // placeholder for the bot message
        const botMessage = document.createElement("div");
        botMessage.innerHTML = `<b>Bot:</b> <i>thinking...</i>`;
        chatDiv.appendChild(botMessage);

        sendButton.disabled = true;
        promptInput.disabled = true;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, model, prompt, system_prompt })
            });

            if (!res.ok || !res.body) {
                throw new Error("Network or response error");
            }

            // replace "thinking..." with an empty string to start streaming
            botMessage.innerHTML = `<b>Bot:</b> `;

            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                botMessage.innerHTML += chunk;

                // auto-scroll
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }

            promptInput.value = '';

        } catch (err) {
            botMessage.innerHTML = `<b>Error:</b> ${err.message}`;
        } finally {
            sendButton.disabled = false;
            promptInput.disabled = false;
            promptInput.focus();
        }
    }


        async function sendPromptOld() {
            const host = document.getElementById('ollama_url').value;
            const model = document.getElementById('model_select').value;
            const prompt = document.getElementById('prompt').value;
            const system_prompt = document.getElementById('system_prompt').value;
            const sendButton = document.getElementById('send_button');
            const chatDiv = document.getElementById('chat');
            chatDiv.innerHTML += `<div><b>You:</b> ${prompt}</div>`;
            chatDiv.innerHTML += `<div><i>thinking...</i></div>`;

            sendButton.disabled = true;
            prompt.disabled = true;

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ host, model, prompt, system_prompt })
                });

                const data = await res.json();

                // remove the last "thinking..." line
                const lastBotThinking = chatDiv.querySelector("div:last-child");
                if (lastBotThinking && lastBotThinking.innerText.includes("thinking")) {
                    chatDiv.removeChild(lastBotThinking);
                }

                chatDiv.innerHTML += `<div><b>Bot:</b> ${data.response}</div>`;
                document.getElementById('prompt').value = '';
            } catch (err) {
                const thinkingEl = document.getElementById("bot-thinking");
                if (thinkingEl) thinkingEl.remove();
                chatDiv.innerHTML += `<div><b>Error:</b> Failed to get response</div>`;
            } finally {
                sendButton.disabled = false;
                prompt.disabled = false;
                prompt.focus();
            }
        }

        fetchModels();
    </script>
</body>
</html>
